<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://api-cdn.amazon.com/sdk/login1.js"></script>
  <link href="public/css/amazon.css" rel="stylesheet">
  <script>
    let CLIENT_ID = '';
    async function fetchClientId() {
      try {
          const response = await fetch('/.netlify/functions/getClientId');
          console.log(response);
          if (!response.ok) {
            throw new Error(`Error fetching clientId: ${response.statusText}`);
          }

          const data = await response.json();
          console.log('DATA')
          console.log(data);
          CLIENT_ID = data.clientId;
          
      } catch (error) {
        console.error('Failed to fetch or set clientId:', error);
      }
    }
    async function loginWithAmazon() {
      try {
        await fetchClientId();
        if (!amazon || !amazon.Login) {
            console.log('TEST');
            throw new Error('Amazon Login SDK is not loaded.');
        }

        amazon.Login.setClientId(CLIENT_ID);
        console.log('TEST 2');
        console.log(CLIENT_ID);
        amazon.Login.setUseCookie(true);
        amazon.Login.authorize(
          {
            client_id: CLIENT_ID,
            scope: 'profile',
            redirect_uri: 'https://aakaarai.com/amazon'
          },
          function (response) {
            if (response.error) {
              console.error('Login failed:', response.error);
              return;
            }
            console.log('Authorization successful! Access Token:', response.access_token);

            amazon.Login.retrieveProfile(response.access_token, function(profileResponse) {
            if (profileResponse.error) {
              console.error('Failed to retrieve profile:', profileResponse.error);
              return;
            }
            console.log('Profile retrieved:', profileResponse);

            // Store the profile data in sessionStorage
            sessionStorage.setItem('amazonProfile', JSON.stringify(profileResponse));

            // Redirect to another page
            window.location.href = 'welcome.html';  // Redirect to /home
          });
          }
        );
      } catch (err) {
        console.error('Error during Amazon Login:', err);
      }
    }
  </script>
</head>
<body>
  <img src="public/img/aakarai-logo-simple.svg" alt="Logo" class="logo">
  <div class="login-card">
  <button class="login-button" onclick="loginWithAmazon()">Login with Amazon</button>
  </div>
  <div class="footer">
    <p>Powered by Amazon Login</p>
  </div>
</body>
</html>