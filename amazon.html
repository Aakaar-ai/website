<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://api-cdn.amazon.com/sdk/login1.js"></script>
  <script>
    async function fetchClientId() {
      try {
        const response = await fetch('/.netlify/functions/getClientId');
        if (!response.ok) throw new Error('Failed to fetch client ID');
        const { clientId } = await response.json();
        return clientId;
      } catch (error) {
        console.error(error);
        return null;
      }
    }

    window.onAmazonLoginReady = async function () {
      const clientId = await fetchClientId();
      if (!clientId) {
        console.error('Client ID is not set.');
        return;
      }
      console.log('Setting Client ID:', clientId);
      amazon.Login.setClientId(clientId);
      amazon.Login.setUseCookie(true);
      amazon.Login.setDebug(true);
    };

    function loginWithAmazon() {
  console.log('Attempting to login...');
  try {
    amazon.Login.authorize(
      {
        scope: 'profile',
        redirect_uri: 'https://your-netlify-site.netlify.app/.netlify/functions/server', // Your redirect URI
      },
      function (response) {
        if (!response) {
          console.error('No response received from Amazon Login API.');
          return;
        }

        if (response.error) {
          console.error('Login failed:', response.error);
          return;
        }

        if (!response.access_token) {
          console.error('Authorization successful, but no access token received.');
          return;
        }

        console.log('Authorization successful! Access Token:', response.access_token);

        // Optionally, handle the token (e.g., send it to your server for further processing)
        fetch('/.netlify/functions/handleToken', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accessToken: response.access_token }),
        })
          .then((res) => res.json())
          .then((data) => console.log('Server Response:', data))
          .catch((err) => console.error('Error sending token to server:', err));
      }
    );
  } catch (error) {
    console.error('An error occurred while trying to log in:', error);
  }
}
  </script>
</head>
<body>
  <button onclick="loginWithAmazon()">Login with Amazon</button>
</body>
</html>